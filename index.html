<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Калькулятор</title>

  <!-- Подключаем VK Bridge (официальная библиотека) -->
  <script src="https://unpkg.com/@vkontakte/vk-bridge/dist/browser.min.js"></script>

  <!-- Инициализируем приложение — обязательно для модерации -->
  <script>
    if (window.vkBridge) {
      vkBridge.send("VKWebAppInit");
    }
  </script>

  <!-- Стили -->
  <style>
    body {
      font-family: 'VK Sans', sans-serif;
      background: #f4f5f7;
      margin: 0;
      padding: 20px;
      color: #2d3340;
    }
    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 1px 10px rgba(0,0,0,0.1);
    }
    h1, h2 {
      margin-top: 0;
      color: #2d3340;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: 500;
    }
    input {
      width: 100%;
      padding: 10px;
      margin: 5px 0 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
    }
    button {
      background: #5181b8;
      color: white;
      border: none;
      padding: 12px 20px;
      margin-top: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      width: 100%;
      font-weight: 600;
    }
    button:hover {
      background: #426c9b;
    }
    p {
      font-size: 16px;
      line-height: 1.5;
    }
    strong {
      color: #5181b8;
    }
  </style>
</head>
<body>

  <!-- Экран формы -->
  <div class="container" id="formScreen">
    <h1>Рассчитаем стоимость кредита</h1>
    <form id="calcForm">
      <label>Сумма (₽): <input type="number" id="amount" placeholder="Например: 100000" required /></label>
      <label>Срок (мес): <input type="number" id="months" placeholder="Например: 12" required /></label>
      <label>Процентная ставка (% годовых): <input type="number" id="rate" placeholder="Например: 30" value="30" step="0.1" required /></label>
      <button type="submit">Рассчитать</button>
    </form>
  </div>

  <!-- Экран результата -->
  <div class="container" id="resultScreen" style="display: none;">
    <h2>Расчёт готов!</h2>
    <p>Ежемесячный платёж: <strong id="payment"></strong> ₽</p>
    <p>Процентная ставка: <strong id="rateValue"></strong>% годовых</p>
    <p>С вами свяжётся наш менеджер для уточнения деталей.</p>
    <button id="backBtn">Назад</button>
  </div>

  <!-- Основной скрипт -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // Подписка на события от VK
      if (window.vkBridge) {
        vkBridge.subscribe((event) => {
          console.log('[VK Event]', event);
          if (event.detail?.type === 'VKWebAppInitResult') {
            console.log('✅ Приложение инициализировано');
          }
        });
      }

      // Элементы
      const formScreen = document.getElementById('formScreen');
      const resultScreen = document.getElementById('resultScreen');
      const calcForm = document.getElementById('calcForm');
      const paymentOutput = document.getElementById('payment');
      const rateValueOutput = document.getElementById('rateValue');
      const backBtn = document.getElementById('backBtn');

      // Формула аннуитетного платежа
      function calculateAnnuityPayment(amount, months, annualRate) {
        const monthlyRate = annualRate / 100 / 12;
        return (amount * monthlyRate * Math.pow(1 + monthlyRate, months)) / (Math.pow(1 + monthlyRate, months) - 1);
      }

      // Обработка формы
      calcForm.onsubmit = (e) => {
        e.preventDefault();
        
        const amount = parseFloat(document.getElementById('amount').value);
        const months = parseInt(document.getElementById('months').value);
        const rate = parseFloat(document.getElementById('rate').value);

        if (isNaN(amount) || isNaN(months) || isNaN(rate) || amount <= 0 || months <= 0 || rate < 0) {
          alert("Введите корректные значения!");
          return;
        }

        const payment = calculateAnnuityPayment(amount, months, rate);
        paymentOutput.textContent = payment.toFixed(2);
        rateValueOutput.textContent = rate;

        // Тактильная обратная связь
        if (window.vkBridge) {
          vkBridge.send("VKWebAppTapticImpactOccurred", { style: "medium" });
        }

        // Переключение экранов
        formScreen.style.display = 'none';
        resultScreen.style.display = 'block';
      };

      // Кнопка "Назад"
      backBtn.onclick = () => {
        formScreen.style.display = 'block';
        resultScreen.style.display = 'none';
        calcForm.reset();
      };
    });
  </script>
</body>
</html>

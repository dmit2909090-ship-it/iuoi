<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–ó —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π</title><!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>–ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–ó —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π</title>
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  body { padding: 20px; font-family: Arial, sans-serif; }
  .section { margin-bottom: 20px; }
  #add-step { margin-top: 15px; }
  .step-item {
    cursor: default;
    transition: box-shadow 0.2s;
    position: relative;
    padding-left: 20px !important;
  }
  .step-item:hover {
    box-shadow: 0 0 8px rgba(0,0,0,0.1);
  }
  .step-item::before {
    content: "";
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #ccc;
  }
  .step-item:first-child::before {
    top: 16px;
  }
  .step-item:last-child::before {
    bottom: 16px;
  }
  .step-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa;
    padding: 8px 12px;
    border-radius: 4px;
    margin: -12px -12px 12px -12px;
  }
  .step-actions .btn {
    padding: 2px 6px;
    font-size: 12px;
  }
  .variant-block, .option-block {
    margin: 10px 0; padding: 10px; border: 1px dashed #aaa; border-radius: 4px; background: #fff;
  }
  .variant-block label, .option-block label {
    display: block; margin-top: 5px; font-weight: bold; font-size: 14px;
  }
  .variant-block input, .variant-block textarea, .option-block input, .option-block textarea {
    width: 100%; padding: 6px; margin-top: 3px; box-sizing: border-box; font-size: 14px;
  }
  .btn-variant, .btn-option { padding: 5px 10px; margin-right: 5px; font-size: 12px; }
  .conditional-container, .assignment-container, .task-container, .notification-container, .news-container {
    margin-top: 15px;
  }
  .form-group label {
    font-weight: bold;
    font-size: 14px;
  }
  select.form-control, input.form-control, textarea.form-control {
    font-size: 14px;
  }
  .step-children {
    margin-left: 30px;
    border-left: 2px solid #ddd;
    padding-left: 15px;
    margin-top: 10px;
  }
  .step-name-input {
    font-weight: bold;
    font-size: 16px;
    width: 100%;
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  .badge-hierarchy {
    font-size: 10px;
    margin-left: 8px;
  }
</style>
</head>
<body>

<div class="container">
<h1 class="mb-4">üß± –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä –¢–ó —Å –∏–µ—Ä–∞—Ä—Ö–∏–µ–π</h1>

<!-- 1. –£—á–∞—Å—Ç–Ω–∏–∫–∏ -->
<div class="section border p-3 rounded">
  <h4>üë§ –ü–æ–¥–ø–∏—à–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h4>
 <div class="mb-2">
  <input type="text" id="new-participant" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
</div>
<div id="participants" class="row"></div>
<button id="add-participant-btn" class="btn btn-primary mt-2">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
</div>

<!-- 2. –®–∞–≥–∏ -->
<div class="section border p-3 rounded">
  <h4>üß© –î–æ–±–∞–≤—å —à–∞–≥–∏ (—Å –ø–æ–¥—à–∞–≥–∞–º–∏ –∏ —É—Å–ª–æ–≤–∏—è–º–∏)</h4>
  <div id="steps-container"></div>
  <button id="add-step" class="btn btn-primary mt-3">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ—Ä–Ω–µ–≤–æ–π —à–∞–≥</button>
</div>

<!-- 3. –≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç -->
<div class="section border p-3 rounded">
  <h4>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ –±—É–¥–µ—Ç –∏–º–µ–Ω–µ–º —Ñ–∞–π–ª–∞</h4>
  <div class="form-group">
    <label>–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞</label>
    <input type="text" id="process-name" class="form-control" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, '–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞—è–≤–æ–∫'" value="–ú–æ–π –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å"/>
  </div>
  <button id="export-btn" class="btn btn-secondary mb-2">üì• –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ —á–µ—Ä–Ω–æ–≤–∏–∫</button>
  <button id="trigger-import" class="btn btn-secondary mb-2 ml-2">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å/–ø—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∞–π–ª</button>
  <input type="file" id="import-file" accept=".json" style="display:none;">
</div>

<!-- 4. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë -->
<div class="section border p-3 rounded">
  <h4>üßπ –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</h4>
  <button id="clear-all-btn" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –¢–ó</button>
</div>

<!-- 5. –°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –¢–ó -->
<div class="section border p-3 rounded">
  <h4>üìÑ –°–æ–∑–¥–∞—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –¢–ó</h4>
  <button id="generate-tz" class="btn btn-warning">‚úÖ –°–æ–∑–¥–∞—Ç—å –∏ —Å–∫–∞—á–∞—Ç—å –¢–ó</button>
  <div id="final-tz" class="mt-3"></div>
</div>

<!-- –ú–µ—Å—Ç–æ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π -->
<div id="message" class="mt-3"></div>

</div>

<script>
$(function() {
  let participants = {};
  let steps = []; // –ú–∞—Å—Å–∏–≤ –∫–æ—Ä–Ω–µ–≤—ã—Ö —à–∞–≥–æ–≤
  let nextId = 1;

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ ID
  function generateId() {
    return 'step_' + nextId++;
  }

  // ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ –≤—Å–µ–≥–æ
  function clearAllData() {
    participants = {};
    steps = [];
    nextId = 1;
    participants["–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1"] = "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å 1";
    renderParticipants();
    renderSteps();
  }

  clearAllData();

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è options –¥–ª—è —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
  function getParticipantOptions(selectedKey = "") {
    return Object.keys(participants).map(k => 
      `<option value="${k}" ${k === selectedKey ? 'selected' : ''}>${k}</option>`
    ).join('');
  }

  // –†–µ–Ω–¥–µ—Ä —à–∞–≥–∞ —Å —Ä–µ–∫—É—Ä—Å–∏–µ–π
  function renderStep(step, level = 0) {
    const id = step.id;
    const participantOptions = getParticipantOptions(step.participant);
    const fromOptions = getParticipantOptions(step.from || Object.keys(participants)[0]);
    const assigneeOptions = getParticipantOptions(step.assignee || Object.keys(participants)[0]);
    const observerOptions = getParticipantOptions(step.observer || "");
    const creatorOptions = getParticipantOptions(step.creator || Object.keys(participants)[0]);

    let contentHtml = '';

    switch(step.action) {
      case "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ":
        contentHtml = `
          <div class="notification-container">
            <div class="form-group">
              <label>–û—Ç –∫–æ–≥–æ</label>
              <select class="form-control notification-from">
                ${fromOptions}
              </select>
            </div>
            <div class="form-group">
              <label>–¢–µ–∫—Å—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
              <textarea class="form-control notification-text" rows="3">${escapeHtml(step.text || '')}</textarea>
            </div>
          </div>
        `;
        break;

      case "–ó–∞–¥–∞–Ω–∏–µ":
        const typeOptions = `
          <option value="–û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ" ${step.type === "–û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ" ? 'selected' : ''}>–û–∑–Ω–∞–∫–æ–º–ª–µ–Ω–∏–µ</option>
          <option value="–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö" ${step.type === "–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö" ? 'selected' : ''}>–í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö</option>
          <option value="–í–≤–æ–¥ —Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º" ${step.type === "–í–≤–æ–¥ —Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º" ? 'selected' : ''}>–í–≤–æ–¥ —Å —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º</option>
          <option value="–õ—é–±–æ–π" ${step.type === "–õ—é–±–æ–π" ? 'selected' : ''}>–õ—é–±–æ–π</option>
        `;

        let optionsHtml = '';
        if (step.options && step.options.length) {
          optionsHtml = step.options.map((opt, i) => `
            <div class="option-block" data-option-index="${i}">
              <label>–í–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞ ${i+1}:</label>
              <input type="text" class="option-text" value="${escapeHtml(opt.text || '')}" placeholder="–¢–µ–∫—Å—Ç –≤–∞—Ä–∏–∞–Ω—Ç–∞">
              <button class="btn btn-sm btn-outline-danger remove-option-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `).join('');
        }

        contentHtml = `
          <div class="assignment-container">
            <div class="form-group">
              <label>–¢–µ–∫—Å—Ç –∑–∞–¥–∞–Ω–∏—è</label>
              <textarea class="form-control assignment-text" rows="3">${escapeHtml(step.text || '')}</textarea>
            </div>
            <div class="form-group">
              <label>–¢–∏–ø –∑–∞–¥–∞–Ω–∏—è</label>
              <select class="form-control assignment-type">
                ${typeOptions}
              </select>
            </div>
            <div class="form-group">
              <label>–ö–∞–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –≤–≤–æ–¥—è—Ç—Å—è (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)</label>
              <textarea class="form-control assignment-data" rows="2">${escapeHtml(step.dataFields || '')}</textarea>
            </div>
            <div class="form-group">
              <button class="btn btn-sm btn-outline-primary add-option-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –æ—Ç–≤–µ—Ç–∞</button>
              <div class="assignment-options mt-2">
                ${optionsHtml}
              </div>
            </div>
          </div>
        `;
        break;

      case "–ù–æ–≤–æ—Å—Ç—å –≤ –ª–µ–Ω—Ç—É":
        contentHtml = `
          <div class="news-container">
            <div class="form-group">
              <label>–û—Ç –∫–æ–≥–æ</label>
              <select class="form-control news-from">
                ${fromOptions}
              </select>
            </div>
            <div class="form-group">
              <label>–¢–µ–∫—Å—Ç –Ω–æ–≤–æ—Å—Ç–∏</label>
              <textarea class="form-control news-text" rows="3">${escapeHtml(step.text || '')}</textarea>
            </div>
          </div>
        `;
        break;

      case "–ó–∞–¥–∞—á–∞":
        contentHtml = `
          <div class="task-container">
            <div class="form-group">
              <label>–ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫</label>
              <select class="form-control task-creator">
                ${creatorOptions}
              </select>
            </div>
            <div class="form-group">
              <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
              <select class="form-control task-assignee">
                ${assigneeOptions}
              </select>
            </div>
            <div class="form-group">
              <label>–ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å</label>
              <select class="form-control task-observer">
                <option value="">‚Äî –ù–µ –≤—ã–±—Ä–∞–Ω ‚Äî</option>
                ${observerOptions}
              </select>
            </div>
            <div class="form-group">
              <label>–°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label>
              <input type="text" class="form-control task-coexecutors" value="${escapeHtml(step.coexecutors || '')}" placeholder="–ò–º—è1, –ò–º—è2, –ò–º—è3">
            </div>
            <div class="form-group">
              <label>–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏</label>
              <textarea class="form-control task-description" rows="3">${escapeHtml(step.description || '')}</textarea>
            </div>
          </div>
        `;
        break;

      case "–£—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ ‚Äî –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è":
        let variantsHtml = '';
        if (step.conditions && step.conditions.length) {
          variantsHtml = step.conditions.map((v, i) => `
            <div class="variant-block" data-condition-index="${i}">
              <label>–£—Å–ª–æ–≤–∏–µ:</label>
              <input type="text" class="condition-text" value="${escapeHtml(v.condition || '')}" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°—É–º–º–∞ > 10000">
              <label>–ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É:</label>
              <select class="condition-next" data-step-id="${id}">
                <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–≥ ‚Äî</option>
                ${getAllStepsOptions(id, v.nextStepId)}
              </select>
              <button class="btn btn-sm btn-outline-danger remove-condition-btn">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
            </div>
          `).join('');
        }

        contentHtml = `
          <div class="conditional-container">
            <div class="form-group">
              <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (—á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —ç—Ç–æ–º –±–ª–æ–∫–µ)</label>
              <textarea class="form-control conditional-comment" rows="2" placeholder="–û–ø–∏—à–∏—Ç–µ –ª–æ–≥–∏–∫—É –±–ª–æ–∫–∞...">${escapeHtml(step.comment || '')}</textarea>
            </div>
            <button class="btn btn-sm btn-outline-primary add-condition-btn">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª–æ–≤–∏–µ –ø–µ—Ä–µ—Ö–æ–¥–∞</button>
            <div class="conditional-variants mt-2">
              ${variantsHtml}
            </div>
          </div>
        `;
        break;

      default:
        contentHtml = `
          <div class="form-group">
            <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
            <textarea class="form-control comment">${step.comment || ''}</textarea>
          </div>
        `;
    }

    // –†–µ–Ω–¥–µ—Ä–∏–º –¥–µ—Ç–µ–π
    let childrenHtml = '';
    if (step.children && step.children.length > 0) {
      childrenHtml = `
        <div class="step-children">
          ${step.children.map(child => renderStep(child, level + 1)).join('')}
        </div>
      `;
    }

    const paddingLeft = level * 30;

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ –¥–≤–∏–≥–∞—Ç—å –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
    let canMoveUp = false;
    let canMoveDown = false;

    if (level === 0) {
      // –ö–æ—Ä–Ω–µ–≤–æ–π —à–∞–≥
      const index = steps.findIndex(s => s.id === id);
      canMoveUp = index > 0;
      canMoveDown = index < steps.length - 1;
    } else {
      // –ü–æ–¥—à–∞–≥ ‚Äî –∏—â–µ–º —Ä–æ–¥–∏—Ç–µ–ª—è
      function findParent(stepList) {
        for (let parent of stepList) {
          if (parent.children && parent.children.some(child => child.id === id)) {
            const index = parent.children.findIndex(child => child.id === id);
            return {
              index,
              length: parent.children.length
            };
          }
          if (parent.children && parent.children.length) {
            const result = findParent(parent.children);
            if (result) return result;
          }
        }
        return null;
      }

      const pos = findParent(steps);
      if (pos) {
        canMoveUp = pos.index > 0;
        canMoveDown = pos.index < pos.length - 1;
      }
    }

    return `
      <div class="border p-2 mb-2 rounded step-item" data-id="${id}" data-level="${level}" style="padding-left: ${paddingLeft + 20}px;">
        <div class="step-header">
          <input type="text" class="step-name-input" value="${escapeHtml(step.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è')}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–≥–∞">
          <span class="badge badge-secondary badge-hierarchy">–£—Ä–æ–≤–µ–Ω—å ${level + 1}</span>
          <div class="step-actions">
            <button class="btn btn-sm btn-outline-primary add-child-step" title="–î–æ–±–∞–≤–∏—Ç—å –ø–æ–¥—à–∞–≥">‚ûï –ü–æ–¥—à–∞–≥</button>
            <button class="btn btn-sm btn-outline-secondary move-up" ${!canMoveUp ? 'disabled' : ''} title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–≤–µ—Ä—Ö">‚ñ≤</button>
            <button class="btn btn-sm btn-outline-secondary move-down" ${!canMoveDown ? 'disabled' : ''} title="–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤–Ω–∏–∑">‚ñº</button>
            <button class="btn btn-sm btn-danger delete-step">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>
        <div class="form-group">
          <label>–¢–∏–ø –¥–µ–π—Å—Ç–≤–∏—è</label>
          <select class="form-control action-select">
            <option value="–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ" ${step.action === "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ" ? 'selected' : ''}>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ</option>
            <option value="–ó–∞–¥–∞–Ω–∏–µ" ${step.action === "–ó–∞–¥–∞–Ω–∏–µ" ? 'selected' : ''}>–ó–∞–¥–∞–Ω–∏–µ</option>
            <option value="–ù–æ–≤–æ—Å—Ç—å –≤ –ª–µ–Ω—Ç—É" ${step.action === "–ù–æ–≤–æ—Å—Ç—å –≤ –ª–µ–Ω—Ç—É" ? 'selected' : ''}>–ù–æ–≤–æ—Å—Ç—å –≤ –ª–µ–Ω—Ç—É</option>
            <option value="–ó–∞–¥–∞—á–∞" ${step.action === "–ó–∞–¥–∞—á–∞" ? 'selected' : ''}>–ó–∞–¥–∞—á–∞</option>
            <option value="–£—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ ‚Äî –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è" ${step.action === "–£—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ ‚Äî –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è" ? 'selected' : ''}>–£—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ ‚Äî –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è</option>
          </select>
        </div>
        <div class="form-group">
          <label>üë§ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å (–ö–æ–º—É)</label>
          <select class="form-control participant-select">
            ${participantOptions}
          </select>
        </div>
        ${contentHtml}
        ${childrenHtml}
      </div>
    `;
  }

  // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —à–∞–≥–∏ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ (–∫—Ä–æ–º–µ —Å–µ–±—è –∏ —Å–≤–æ–∏—Ö –¥–µ—Ç–µ–π)
  function getAllStepsOptions(excludeId, selectedId = "") {
    let allSteps = [];

    function collectSteps(stepList, prefix = "") {
      stepList.forEach(s => {
        if (s.id !== excludeId) {
          allSteps.push({
            id: s.id,
            name: s.name || `–®–∞–≥ (${s.action})`,
            prefix: prefix
          });
        }
        if (s.children && s.children.length) {
          collectSteps(s.children, prefix + "‚Äî ");
        }
      });
    }

    collectSteps(steps);

    return allSteps.map(s => 
      `<option value="${s.id}" ${s.id === selectedId ? 'selected' : ''}>${s.prefix}${s.name}</option>`
    ).join('');
  }

  // –†–µ–Ω–¥–µ—Ä –≤—Å–µ—Ö –∫–æ—Ä–Ω–µ–≤—ã—Ö —à–∞–≥–æ–≤
  function renderSteps() {
    $('#steps-container').empty();
    steps.forEach(step => {
      $('#steps-container').append(renderStep(step, 0));
    });

    // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    attachEventHandlers();
  }

  // –û–±–Ω–æ–≤–∏—Ç—å –≤—Å–µ –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ "–ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É" –≤ —É—Å–ª–æ–≤–Ω—ã—Ö –±–ª–æ–∫–∞—Ö
  function updateAllConditionNextSelects() {
    $('.condition-next').each(function() {
      const $select = $(this);
      const currentVal = $select.val();
      const excludeId = $select.closest('[data-id]').data('id');

      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —à–∞–≥–∏, –∫—Ä–æ–º–µ —Ç–µ–∫—É—â–µ–≥–æ –∏ –µ–≥–æ –¥–µ—Ç–µ–π
      let allSteps = [];

      function collectSteps(stepList, prefix = "") {
        stepList.forEach(s => {
          if (s.id !== excludeId) {
            allSteps.push({
              id: s.id,
              name: s.name || `–®–∞–≥ (${s.action})`,
              prefix: prefix
            });
          }
          if (s.children && s.children.length) {
            collectSteps(s.children, prefix + "‚Äî ");
          }
        });
      }

      collectSteps(steps);

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π HTML
      let optionsHtml = `<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–≥ ‚Äî</option>`;
      optionsHtml += allSteps.map(s => 
        `<option value="${s.id}" ${s.id === currentVal ? 'selected' : ''}>${s.prefix}${s.name}</option>`
      ).join('');

      // –û–±–Ω–æ–≤–ª—è–µ–º
      $select.html(optionsHtml);
    });
  }

  function attachEventHandlers() {
    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è —à–∞–≥–∞
    $('#steps-container').off('input', '.step-name-input').on('input', '.step-name-input', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) {
        step.name = $(this).val();
        // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –í–°–ï –≤—ã–ø–∞–¥–∞—é—â–∏–µ —Å–ø–∏—Å–∫–∏ "–ü–µ—Ä–µ—Ö–æ–¥ –∫ —à–∞–≥—É" –≤ —É—Å–ª–æ–≤–Ω—ã—Ö –±–ª–æ–∫–∞—Ö
        updateAllConditionNextSelects();
      }
    });

    // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ç–∏–ø–∞ –¥–µ–π—Å—Ç–≤–∏—è
    $('#steps-container').off('change', '.action-select').on('change', '.action-select', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (!step) return;

      const newAction = $(this).val();
      step.action = newAction;

      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–¥ –Ω–æ–≤—ã–π —Ç–∏–ø
      switch(newAction) {
        case "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ":
          step.from = step.from || Object.keys(participants)[0];
          step.text = step.text || "";
          break;
        case "–ó–∞–¥–∞–Ω–∏–µ":
          step.text = step.text || "";
          step.type = step.type || "–õ—é–±–æ–π";
          step.dataFields = step.dataFields || "";
          step.options = step.options || [];
          break;
        case "–ù–æ–≤–æ—Å—Ç—å –≤ –ª–µ–Ω—Ç—É":
          step.from = step.from || Object.keys(participants)[0];
          step.text = step.text || "";
          break;
        case "–ó–∞–¥–∞—á–∞":
          step.creator = step.creator || Object.keys(participants)[0];
          step.assignee = step.assignee || step.participant;
          step.observer = step.observer || "";
          step.coexecutors = step.coexecutors || "";
          step.description = step.description || "";
          break;
        case "–£—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ ‚Äî –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è":
          step.conditions = step.conditions || [];
          break;
      }

      renderSteps();
    });

    // –û—Å–Ω–æ–≤–Ω–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ ‚Äî —Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π assignee –¥–ª—è –∑–∞–¥–∞—á–∏
    $('#steps-container').off('change', '.participant-select').on('change', '.participant-select', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) {
        step.participant = $(this).val();
        // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞–¥–∞—á–∞ ‚Äî —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º assignee
        if (step.action === "–ó–∞–¥–∞—á–∞") {
          step.assignee = $(this).val();
        }
      }
    });

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    $('#steps-container').off('change', '.notification-from').on('change', '.notification-from', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.from = $(this).val();
    });

    $('#steps-container').off('input', '.notification-text').on('input', '.notification-text', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.text = $(this).val();
    });

    // –ó–∞–¥–∞–Ω–∏–µ
    $('#steps-container').off('input', '.assignment-text').on('input', '.assignment-text', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.text = $(this).val();
    });

    $('#steps-container').off('change', '.assignment-type').on('change', '.assignment-type', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.type = $(this).val();
    });

    $('#steps-container').off('input', '.assignment-data').on('input', '.assignment-data', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.dataFields = $(this).val();
    });

    // –í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–∞
    $('#steps-container').off('click', '.add-option-btn').on('click', '.add-option-btn', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (!step.options) step.options = [];
      step.options.push({ text: '' });
      renderSteps();
    });

    $('#steps-container').off('click', '.remove-option-btn').on('click', '.remove-option-btn', function() {
      const optionBlock = $(this).closest('.option-block');
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      const optionIndex = parseInt(optionBlock.data('option-index'));
      step.options.splice(optionIndex, 1);
      renderSteps();
    });

    $('#steps-container').off('input', '.option-text').on('input', '.option-text', function() {
      const optionBlock = $(this).closest('.option-block');
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      const optionIndex = parseInt(optionBlock.data('option-index'));
      step.options[optionIndex].text = $(this).val();
    });

    // –ù–æ–≤–æ—Å—Ç—å
    $('#steps-container').off('change', '.news-from').on('change', '.news-from', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.from = $(this).val();
    });

    $('#steps-container').off('input', '.news-text').on('input', '.news-text', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.text = $(this).val();
    });

    // –ó–∞–¥–∞—á–∞
    $('#steps-container').off('change', '.task-creator').on('change', '.task-creator', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.creator = $(this).val();
    });

    $('#steps-container').off('change', '.task-assignee').on('change', '.task-assignee', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) {
        step.assignee = $(this).val();
        step.participant = $(this).val();
      }
    });

    $('#steps-container').off('change', '.task-observer').on('change', '.task-observer', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.observer = $(this).val();
    });

    $('#steps-container').off('input', '.task-coexecutors').on('input', '.task-coexecutors', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.coexecutors = $(this).val();
    });

    $('#steps-container').off('input', '.task-description').on('input', '.task-description', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.description = $(this).val();
    });

    // –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–ª—è —É—Å–ª–æ–≤–Ω–æ–≥–æ –±–ª–æ–∫–∞
    $('#steps-container').off('input', '.conditional-comment').on('input', '.conditional-comment', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (step) step.comment = $(this).val();
    });

    // –£—Å–ª–æ–≤–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
    $('#steps-container').off('click', '.add-condition-btn').on('click', '.add-condition-btn', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (!step.conditions) step.conditions = [];
      step.conditions.push({ condition: '', nextStepId: '' });
      renderSteps();
    });

    $('#steps-container').off('click', '.remove-condition-btn').on('click', '.remove-condition-btn', function() {
      const conditionBlock = $(this).closest('.variant-block');
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      const conditionIndex = parseInt(conditionBlock.data('condition-index'));
      step.conditions.splice(conditionIndex, 1);
      renderSteps();
    });

    $('#steps-container').off('input', '.condition-text').on('input', '.condition-text', function() {
      const conditionBlock = $(this).closest('.variant-block');
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      const conditionIndex = parseInt(conditionBlock.data('condition-index'));
      step.conditions[conditionIndex].condition = $(this).val();
    });

    $('#steps-container').off('change', '.condition-next').on('change', '.condition-next', function() {
      const conditionBlock = $(this).closest('.variant-block');
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      const conditionIndex = parseInt(conditionBlock.data('condition-index'));
      step.conditions[conditionIndex].nextStepId = $(this).val();
    });

    // –£–¥–∞–ª–µ–Ω–∏–µ —à–∞–≥–∞
    $('#steps-container').off('click', '.delete-step').on('click', '.delete-step', function() {
      const id = $(this).closest('[data-id]').data('id');
      if (confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–≥ –∏ –≤—Å–µ –ø–æ–¥—à–∞–≥–∏?')) {
        deleteStepById(id);
        renderSteps();
      }
    });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥—à–∞–≥–∞
    $('#steps-container').off('click', '.add-child-step').on('click', '.add-child-step', function() {
      const id = $(this).closest('[data-id]').data('id');
      const step = findStepById(id);
      if (!step.children) step.children = [];

      const firstParticipant = Object.keys(participants)[0] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
      step.children.push(createEmptyStep(firstParticipant));
      renderSteps();
    });

    // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑ (—Ç–æ–ª—å–∫–æ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Ä–æ–¥–∏—Ç–µ–ª—è)
    $('#steps-container').off('click', '.move-up').on('click', '.move-up', function() {
      const id = $(this).closest('[data-id]').data('id');
      moveStep(id, -1);
    });

    $('#steps-container').off('click', '.move-down').on('click', '.move-down', function() {
      const id = $(this).closest('[data-id]').data('id');
      moveStep(id, 1);
    });
  }

  // –°–æ–∑–¥–∞—Ç—å –ø—É—Å—Ç–æ–π —à–∞–≥
  function createEmptyStep(participant) {
    return {
      id: generateId(),
      name: "–ù–æ–≤—ã–π —à–∞–≥",
      action: "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ",
      participant: participant,
      from: participant,
      text: "",
      type: "–õ—é–±–æ–π",
      dataFields: "",
      options: [],
      conditions: [],
      assignee: participant,
      observer: "",
      creator: participant,
      coexecutors: "",
      description: "",
      children: []
    };
  }

  // –ü–æ–∏—Å–∫ —à–∞–≥–∞ –ø–æ ID (—Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ)
  function findStepById(id, stepList = steps) {
    for (let step of stepList) {
      if (step.id === id) return step;
      if (step.children && step.children.length) {
        const found = findStepById(id, step.children);
        if (found) return found;
      }
    }
    return null;
  }

  // –£–¥–∞–ª–µ–Ω–∏–µ —à–∞–≥–∞ –ø–æ ID
  function deleteStepById(id, stepList = steps) {
    for (let i = 0; i < stepList.length; i++) {
      if (stepList[i].id === id) {
        stepList.splice(i, 1);
        return true;
      }
      if (stepList[i].children && stepList[i].children.length) {
        if (deleteStepById(id, stepList[i].children)) return true;
      }
    }
    return false;
  }

  // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ —à–∞–≥–∞ –≤–≤–µ—Ä—Ö/–≤–Ω–∏–∑
  function moveStep(id, direction) {
    // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä–∏–º, –∫–æ—Ä–Ω–µ–≤–æ–π –ª–∏ —ç—Ç–æ —à–∞–≥
    const rootIndex = steps.findIndex(s => s.id === id);
    if (rootIndex !== -1) {
      // –≠—Ç–æ –∫–æ—Ä–Ω–µ–≤–æ–π —à–∞–≥ ‚Äî –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ –º–∞—Å—Å–∏–≤–µ steps
      const newIndex = rootIndex + direction;
      if (newIndex >= 0 && newIndex < steps.length) {
        [steps[rootIndex], steps[newIndex]] = [steps[newIndex], steps[rootIndex]];
        renderSteps();
      }
      return;
    }

    // –ï—Å–ª–∏ –Ω–µ –∫–æ—Ä–Ω–µ–≤–æ–π ‚Äî –∏—â–µ–º –≤–Ω—É—Ç—Ä–∏ –¥–µ—Ç–µ–π
    function findAndMoveInParent(stepList) {
      for (let i = 0; i < stepList.length; i++) {
        const currentStep = stepList[i];
        if (currentStep.children && currentStep.children.length) {
          const childIndex = currentStep.children.findIndex(child => child.id === id);
          if (childIndex !== -1) {
            // –ù–∞—à–ª–∏ —Ä–µ–±–µ–Ω–∫–∞ ‚Äî –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤–Ω—É—Ç—Ä–∏ children
            const newIndex = childIndex + direction;
            if (newIndex >= 0 && newIndex < currentStep.children.length) {
              [currentStep.children[childIndex], currentStep.children[newIndex]] = 
              [currentStep.children[newIndex], currentStep.children[childIndex]];
              renderSteps();
            }
            return true;
          }
          // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –∏—â–µ–º –≥–ª—É–±–∂–µ
          if (findAndMoveInParent(currentStep.children)) return true;
        }
      }
      return false;
    }

    findAndMoveInParent(steps);
  }

  // –£—á–∞—Å—Ç–Ω–∏–∫–∏
  function renderParticipants() {
    $('#participants').empty();
    for (const [key, value] of Object.entries(participants)) {
      $('#participants').append(`
        <div class="col-4 mb-2">
          <input type="text" class="form-control participant-input" value="${value}" data-key="${key}" placeholder="–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞" />
        </div>
      `);
    }
  }

  $('#participants').on('input', '.participant-input', function() {
    const oldKey = $(this).data('key');
    const newValue = $(this).val().trim();

    if (!newValue) {
      showMsg('–ò–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º', false);
      $(this).val(participants[oldKey]);
      return;
    }

    for (const key of Object.keys(participants)) {
      if (key !== oldKey && participants[key] === newValue) {
        showMsg('–£—á–∞—Å—Ç–Ω–∏–∫ —Å —Ç–∞–∫–∏–º –∏–º–µ–Ω–µ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', false);
        $(this).val(participants[oldKey]);
        return;
      }
    }

    const oldValue = participants[oldKey];
    delete participants[oldKey];
    participants[newValue] = newValue;
    $(this).data('key', newValue);

    function updateStepParticipants(step) {
      if (step.participant === oldValue) step.participant = newValue;
      if (step.from === oldValue) step.from = newValue;
      if (step.assignee === oldValue) step.assignee = newValue;
      if (step.observer === oldValue) step.observer = newValue;
      if (step.creator === oldValue) step.creator = newValue;
      if (step.children && step.children.length) {
        step.children.forEach(updateStepParticipants);
      }
    }

    steps.forEach(updateStepParticipants);
    renderSteps();
  });

  $('#add-participant-btn').on('click', function() {
    const newName = $('#new-participant').val().trim();
    if (!newName) {
      showMsg('–í–≤–µ–¥–∏—Ç–µ –∏–º—è —É—á–∞—Å—Ç–Ω–∏–∫–∞', false);
      return;
    }

    if (participants[newName] !== undefined) {
      showMsg('–¢–∞–∫–æ–π —É—á–∞—Å—Ç–Ω–∏–∫ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', false);
      return;
    }

    participants[newName] = newName;
    $('#new-participant').val('');
    renderParticipants();
    renderSteps();
    showMsg('–£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω', true);
  });

  $('#new-participant').on('keydown', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      $('#add-participant-btn').click();
    }
  });

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ —à–∞–≥–∞
  $('#add-step').click(() => {
    const firstParticipant = Object.keys(participants)[0] || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π";
    steps.push(createEmptyStep(firstParticipant));
    renderSteps();
  });

  // –≠–∫—Å–ø–æ—Ä—Ç
  $('#export-btn').click(() => {
    const processName = $('#process-name').val().trim() || '–ú–æ–π –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å';
    const now = new Date();
    const timestamp = now.toISOString().replace(/[:.]/g, '-').substring(0, 19);
    const safeName = processName.replace(/\s+/g, '_').replace(/[^\w–∞-—è–ê-–Ø—ë–Å_-]/g, '');

    const data = {
      participants,
      steps,
      nextId,
      date: now.toISOString(),
      processName
    };

    const jsonStr = JSON.stringify(data, null, 2);
    const blob = new Blob([jsonStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${safeName}_${timestamp}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  // –ò–º–ø–æ—Ä—Ç
  $('#trigger-import').click(() => {
    $('#import-file').click();
  });

  $('#import-file').change(() => {
    const file = $('#import-file')[0].files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      try {
        const data = JSON.parse(reader.result);
        if (data.participants && data.steps) {
          clearAllData();
          participants = data.participants;
          steps = data.steps;
          nextId = data.nextId || 1;
          if (data.processName) $('#process-name').val(data.processName);
          renderParticipants();
          renderSteps();
          showMsg('–ß–µ—Ä–Ω–æ–≤–∏–∫ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω', true);
        } else {
          showMsg('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–∞–π–ª', false);
        }
      } catch(e) {
        showMsg('–û—à–∏–±–∫–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞: ' + e.message, false);
      }
    };
    reader.readAsText(file);
  });

  // –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë
  $('#clear-all-btn').click(() => {
    if (confirm('‚ö†Ô∏è –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –¢–ó? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
      clearAllData();
      showMsg('–¢–ó –æ—á–∏—â–µ–Ω–æ', true);
    }
  });

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¢–ó
  $('#generate-tz').click(() => {
    const processName = $('#process-name').val().trim() || '–ú–æ–π –±–∏–∑–Ω–µ—Å-–ø—Ä–æ—Ü–µ—Å—Å';

    // –°–æ–±–∏—Ä–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
    const renderedParticipants = {};
    $('#participants .participant-input').each(function() {
      const key = $(this).data('key');
      const value = $(this).val().trim();
      if (value) renderedParticipants[key] = value;
    });

    function collectStepsForExport(stepList, level = 0) {
      let result = [];
      stepList.forEach(s => {
        let stepData = { ...s };
        delete stepData.children; // —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏ —Ä–µ–∫—É—Ä—Å–∏–∏

        result.push({
          ...stepData,
          level: level
        });

        if (s.children && s.children.length) {
          result = result.concat(collectStepsForExport(s.children, level + 1));
        }
      });
      return result;
    }

    const allSteps = collectStepsForExport(steps);

    if (allSteps.length === 0) {
      showMsg('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —à–∞–≥', false);
      return;
    }

    let text = `üéØ –ù–∞–∑–≤–∞–Ω–∏–µ: ${processName}\nüóìÔ∏è –î–∞—Ç–∞: ${new Date().toLocaleString()}\n\nüë• –£—á–∞—Å—Ç–Ω–∏–∫–∏:\n`;
    text += Object.entries(renderedParticipants).map(([k,v]) => `- ${k}: ${v}`).join('\n');
    text += `\n\nüìù –®–∞–≥–∏:\n`;

    allSteps.forEach((s, i) => {
      const indent = "  ".repeat(s.level);
      text += `${indent}${i+1}. [${s.name || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}] (${s.action}) ‚Üí ${s.participant}\n`;

      switch(s.action) {
        case "–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ":
          text += `${indent}   –û—Ç: ${s.from}\n`;
          text += `${indent}   –¢–µ–∫—Å—Ç: ${s.text || '‚Äî'}\n`;
          break;
        case "–ó–∞–¥–∞–Ω–∏–µ":
          text += `${indent}   –¢–µ–∫—Å—Ç: ${s.text || '‚Äî'}\n`;
          text += `${indent}   –¢–∏–ø: ${s.type}\n`;
          if (s.dataFields) text += `${indent}   –î–∞–Ω–Ω—ã–µ: ${s.dataFields}\n`;
          if (s.options && s.options.length) {
            s.options.forEach((opt, idx) => {
              text += `${indent}   –í–∞—Ä–∏–∞–Ω—Ç ${idx+1}: ${opt.text}\n`;
            });
          }
          break;
        case "–ù–æ–≤–æ—Å—Ç—å –≤ –ª–µ–Ω—Ç—É":
          text += `${indent}   –û—Ç: ${s.from}\n`;
          text += `${indent}   –¢–µ–∫—Å—Ç: ${s.text || '‚Äî'}\n`;
          break;
        case "–ó–∞–¥–∞—á–∞":
          text += `${indent}   –ü–æ—Å—Ç–∞–Ω–æ–≤—â–∏–∫: ${s.creator}\n`;
          text += `${indent}   –û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π: ${s.assignee}\n`;
          if (s.observer) text += `${indent}   –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å: ${s.observer}\n`;
          if (s.coexecutors) text += `${indent}   –°–æ–∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏: ${s.coexecutors}\n`;
          if (s.description) text += `${indent}   –û–ø–∏—Å–∞–Ω–∏–µ: ${s.description}\n`;
          break;
        case "–£—Å–ª–æ–≤–Ω—ã–π –±–ª–æ–∫ ‚Äî –í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è":
          if (s.comment) {
            text += `${indent}   –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${s.comment}\n`;
          }
          if (s.conditions && s.conditions.length) {
            s.conditions.forEach((v, idx) => {
              text += `${indent}   –£—Å–ª–æ–≤–∏–µ ${idx+1}: ${v.condition || '‚Äî'} ‚Üí –ü–µ—Ä–µ—Ö–æ–¥ –∫: ${v.nextStepId || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}\n`;
            });
          }
          break;
      }
    });

    $('#final-tz').html(`<pre>${text}</pre>`);
    const blob = new Blob([text], {type: 'text/plain;charset=utf-8'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = processName.replace(/\s+/g, '_') + '_—Ç–∑.txt';
    a.click();
    URL.revokeObjectURL(url);
  });

  function showMsg(msg, success) {
    $('#message').html(`<div class="alert ${success ? 'alert-success' : 'alert-danger'}">${msg}</div>`);
    setTimeout(() => { $('#message').empty(); }, 3000);
  }

  function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
});

</script>

</body>
</html>
